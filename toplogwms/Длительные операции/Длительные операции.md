# Длительные операции
* Мехнизм Длительных операций позволяет запускать фоновые задания и фикисровать состояния запущенных заданий в регистре сведений ДлительныеОперации.
#### Запуск длительных операций
* Используемый метод: ДлительныеОперации.Запустить(<ВыполняемаяФункция>, <МассивПараметровВыполняемойФункции>, <ИдентификаторДлительнойОперации>)
* Параметры:
	<ВыполняемаяФункция> (обязательный)
	Тип: Строка. 
	Строка, содержащая текст исполняемого кода без параметров последнего вызываемого метода.
	<МассивПараметровВыполняемойФункции> (необязательный)
	Тип: Неопределено, Массив.
	Содержит параметры выполняемой функции. Порядок параметров соответствует порядку элементов в массиве. Если передан массив, значение вычесленного выражения будет присвоено переменной РезультатВыполнения. Если значения параметра - Неопределено, явного присвоения значения не произойдет. 
	Значение по умолчанию: Неопределено
	<ИдентификаторДлительнойОперации> (необязательный)
	Тип: Произвольный
	Значение параметра приводится к строке и присваивается идентификатору создаваемой записи регистра сведений ДлительныеОперации. Значение также используется, как ключ фонового задания. Если параметр не передан, генерируется новый Уникальный идентификатор.
	Значение по умолчанию: Неопределено
* Возвращаемое значение:
	Тип: Строка
	Возвращает ключ запущенного фонового задания.
* Описание:
	Функция пишет в регистр сведений ДлительныеОперации запись с переданным или сгенерированным идентификатором и Состоянием Выполяется. Далее запускается фоновое задание с переданной функцией и переданными параметрами функции. В ходе выполнения фонового задания может быть вычеслено значение переменной РезультатВыполнения. Значения переменной по умолчанию: Неопределено. В РС ДлительныеОперации добаляется запись с полученным значением Результат Выполнения и Состоянием Завершен. При возникновении ошибки выполнения в регистр добавляется запись со значением Состояния Отменен. При использовании режима отладки вместо запуска фонового задания выполняется синхронное вычисление переданного выражения. Использование режима отладки определяется значениеи константы ОтладкаДлительныхОпераций.
		
#### Проверка выполнения 
* Используемый метод: РегистрыСведений.ДлительныеОперации.ПроверитьВыполнение(<ИдентификаторДлительнойОперации>, <Таймаут>)
* Параметры:
	<ИдентификаторДлительнойОперации> (обязательный)
	Тип: Строка. 
	<Таймаут> (необязательный)
	Тип: Неопределено, Число.
	Если передано числовое значение и фоновое задание находится в активном состоянии, будет вызвано ожидание завершения задания с указанным таймаутом.
	Значение по умолчанию: Неопределено
* Возвращаемое значение:
	Тип: Структура.
	Поля структуры: Состояние, ПроизошлаОшибка, ТекстОшибки, РезультатВыполнения.
* Описание: 
	Функция читает данные РС ДлительныеОперации по переданному идентификатору. Если состояние операции Выполняется, проверяется состояние фонового задания. Если задание завершено аварийно, состояние записи меняется на Отменен. Если задание активно и передан Таймаут, выполняется ожидание завершения. Структура возврата заполняется актуальными данными регистра.
## Мобильные терминалы
* Параметры процесса
		ДлитиельныеОперации. 
		Тип: Соответствие.
		Контейнер длительных операций процесса.
		ОжидатьЗавершенияДлительныхОпераций. 
		Тип: Булево.
		Значение параметра Истина блокирует выполнение процесса.
		
#### Проверка состояния длительной операции
* Выполняется в обработчике Post-запроса HTTP-сервиса TSD по шаблону "/durableProcedure".
	В теле запроса передаетя JSON-документ, содержащий следующие обязательные поля:
		Оборудование
		Сеанс
		Действие
		Шаг
* Описание:
	Выполняет запуск процесс по параметрам, переданным в теле запроса. Для всех длительных операций процесса выполняется проверка выполнения без таймаута. Если не обнаруживается ни одной длительной операции в состоянии Выполняется, у процесса сбрасывается флаг ОжидатьЗавершенияДлительныхОпераций, данные о всех длительных операциях процесса удаляются из РС ДлительныеОперации. 


### Запуск длительных операций из обработок мобильных терминалов
* Каждая обработка мобильного терминала содержит экспортую переменную мДлитиельныеОперации. При инициализации обработки значение переменной инициализируетя параметром процесса ДлительныеОперации. 
* Инициация запуска длительных операций из обработок мобильных терминалов возможна из следующих точек
		Функция Инициализировать() 
		Функция ПодготовитьДействие(<ДействиеФормы>)
		Функция ОбработатьДействие() 
	Для инициации длительной операции любая из этих функций должна вернуть результат выполнения функции ТерминалыМобильные.ВыполнитьДлительнуюОперацию
	
#### Поиск длительной операции в коллекции
* Используемый метод:  ТерминалыМобильные.ПолучитьДлительнуюОперацию(<Ключ>, <ДлительныеОперации>)
* Параметры:
	<Ключ> (обязательный)
	Тип: Произвольный. 
	Ключ соответствия длительных операций
	<ДлительныеОперации> (обязательный)
	Тип: Соответствие.
	Коллекция, в которой ищется значение.
* Возвращаемое значение:
	Тип: Неопределено, Структура.
* Описание:
	Работает аналогично методу объекта Соответствия Получить(<Ключ>)

#### Добавление длительной операции в коллекцию
* Используемый метод: ТерминалыМобильные.ВыполнитьДлительнуюОперацию(<Ключ>, <ИмяФункции>, <МассивПараметров>, <ДлительныеОперации>)
* Параметры:
	<Ключ> (обязательный)
	Тип: Произвольный. 
	Ключ соответствия длительных операций
	<ИмяФункции> (обязательный)
	Тип: Строка.
	Строка, содержащая текст исполняемого кода без параметров последнего вызываемого метода.
	<МассивПараметров> (обязательный)
	Тип: Неопределено, Массив.
	Содержит параметры выполняемой функции. Порядок параметров соответствует порядку элементов в массиве.
	<ДлительныеОперации> (обязательный)
	Тип: Соответствие.
	Коллекция, в которую добавляется значение.
* Возвращаемое значение:
	Тип: Структура.
	Ключ структуры - "ДлительнаяОперация", значение - структруа запуска длительной операции.
* Описание:
	Формирует структуру для запуска длительной операции, помещает ее в оберточную структуру.
