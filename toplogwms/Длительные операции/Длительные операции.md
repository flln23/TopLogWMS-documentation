
# Длительные операции

* Мехнизм Длительных операций позволяет запускать фоновые задания и фикисровать состояния запущенных заданий в регистре сведений ДлительныеОперации.

### Запуск длительных операций

#### Используемый метод: 

```bsl
    ДлительныеОперации.Запустить(<ВыполняемаяФункция>, <МассивПараметровВыполняемойФункции>, <ИдентификаторДлительнойОперации>)
```

#### Параметры:

* <ВыполняемаяФункция> (обязательный)

	Тип: Строка. 

	Если в параметре МассивПараметровВыполняемойФункции передан массив, значение параметра ВыполняемаяФункция - имя вызываемой функции без параметров и скобок. Результат выполнения функции будет присвоен переменной РезультатВыполнения. Если в параметре МассивПараметровВыполняемойФункции передано значение Неопределено, значение параметра ВыполняемаяФункция - текст исполняемого кода.

* <МассивПараметровВыполняемойФункции> (необязательный)

	Тип: Неопределено, Массив.

	Содержит параметры выполняемой функции. Порядок параметров соответствует порядку элементов в массиве. Если передан массив, значение вычесленного выражения будет присвоено переменной РезультатВыполнения. Если значения параметра - Неопределено, явного присвоения значения не произойдет. 

	Значение по умолчанию: Неопределено

* <ИдентификаторДлительнойОперации> (необязательный)

	Тип: Неопределено, УникальныйИдентификатор.

	Значение параметра приводится к строке и присваивается идентификатору создаваемой записи регистра сведений ДлительныеОперации. Значение также используется, как ключ фонового задания. Если параметр не передан, генерируется новый Уникальный идентификатор.
	
	Значение по умолчанию: Неопределено

####  Возвращаемое значение:

* Тип: Строка
* Возвращает ключ запущенного фонового задания.

#### Описание:

>Функция пишет в регистр сведений ДлительныеОперации запись с переданным или сгенерированным идентификатором и Состоянием Выполяется. Далее запускается фоновое задание с переданной функцией и переданными параметрами функции. В ходе выполнения фонового задания может быть вычеслено значение переменной РезультатВыполнения. Значения переменной по умолчанию: Неопределено. В РС ДлительныеОперации добаляется запись с полученным значением Результат Выполнения и Состоянием Завершен. При возникновении ошибки выполнения в регистр добавляется запись со значением Состояния Отменен. При использовании режима отладки вместо запуска фонового задания выполняется синхронное вычисление переданного выражения. Использование режима отладки определяется значениеи константы ОтладкаДлительныхОпераций.

#### Пример использования:

```bsl
	ИсполняемаяИструкция = "ПланированиеТовародвижения.ВыполнитьРазмещение"; 
		
	МассивПарметровВыполнения = Новый Массив;
	МассивПарметровВыполнения.Добавить(мСкладскаяОперация);
	МассивПарметровВыполнения.Добавить(мРеквизиты.ОбъектыРазмещения);
	МассивПарметровВыполнения.Добавить(мРеквизиты.Адрес);
	МассивПарметровВыполнения.Добавить(Зона); 
	МассивПарметровВыполнения.Добавить(мРеквизиты.ТекущийДокумент); 

	Идентификатор = Новый УникальныйИдентификатор;
	УИДДлительнойОперации = ДлительныеОперации.Запустить(ИсполняемаяИструкция, МассивПарметровВыполнения, Идентификатор);
	
```
		
### Проверка выполнения 

#### Используемый метод: 

```bsl
    РегистрыСведений.ДлительныеОперации.ПроверитьВыполнение(<ИдентификаторДлительнойОперации>, <Таймаут>)
```

#### Параметры:

* <ИдентификаторДлительнойОперации> (обязательный)

	 Тип: Строка. 

	 Идентификатор, который был получен в результате вызова ДлительныеОперации.Запустить().

* <Таймаут> (необязательный)

 	Тип: Неопределено, Число.
 
 	Если передано числовое значение и фоновое задание находится в активном состоянии, будет вызвано ожидание завершения задания с указанным таймаутом.
	Значение по умолчанию: Неопределено.

#### Возвращаемое значение:

* Тип: Структура.
* Поля структуры: Состояние, ПроизошлаОшибка, ТекстОшибки, РезультатВыполнения.

#### Описание: 

>Функция читает данные РС ДлительныеОперации по переданному идентификатору. Если состояние операции Выполняется, проверяется состояние фонового задания. Если задание завершено аварийно, состояние записи меняется на Отменен. Если задание активно и передан Таймаут, выполняется ожидание завершения. Структура возврата заполняется актуальными данными регистра. Функция использует привилегированный режим.

#### Пример использования:

```bsl
	СписокДлительныхОпераций = Процесс.ДлительныеОперации;
	Для Каждого ОписаниеДлительнойОперации Из СписокДлительныхОпераций Цикл
		ИдентификаторДлительнойОперации = ОписаниеДлительнойОперации.Значение.Идентификатор;
		РезультатПроверки = РегистрыСведений.ДлительныеОперации.ПроверитьВыполнение(ИдентификаторДлительнойОперации);
		Если РезультатПроверки.Состояние = Перечисления.СостоянияОбъектов.Выполняется Тогда
			...
		КонецЕсли;
	КонецЦикла;
	
```

### Удаление заданий

#### Используемый метод: 

```bsl
    РегистрыСведений.ДлительныеОперации.УдалитьДанныеДлительнойОперации(<Идентификатор>)
```
#### Параметры:

* <Идентификатор> (обязательный)

	 Тип: Строка. 

	 Идентификатор, который был получен в результате вызова ДлительныеОперации.Запустить().

#### Описание: 

>Процедура удаляет записи регистра сведений ДлительныеОперации с отбором по переданному Идентификатору. Вызов процедуры должен быть обязательно выполнен после того, как обработчик получил результат выполнения длительной операции. Процедура использует привилегированный режим.